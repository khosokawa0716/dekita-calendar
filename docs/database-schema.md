# Firebase Firestore ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©æ›¸

## æ¦‚è¦

æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€Firebase Firestore ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
å®¶æ—å˜ä½ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢ã—ã€è¦ªãƒ»å­ã®å½¹å‰²ã«åŸºã¥ã„ãŸã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“Š ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆ

```
firestore/
â”œâ”€â”€ users/           # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
â”œâ”€â”€ tasks/           # ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ taskTemplates/   # ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â””â”€â”€ achievements/    # é”æˆè¨˜éŒ²
```

---

## 1. ğŸ‘¤ users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè¦ªãƒ»å­ï¼‰ã®åŸºæœ¬æƒ…å ±ã‚’ç®¡ç†

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | å‹        | å¿…é ˆ | èª¬æ˜                                 | ä¾‹                      |
| ------------ | --------- | ---- | ------------------------------------ | ----------------------- |
| id           | string    | âœ…   | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆFirebase Authã®UIDï¼‰ | "firebase_auth_uid_123" |
| email        | string    | âœ…   | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹                       | "parent@example.com"    |
| displayName  | string    | âœ…   | è¡¨ç¤ºå                               | "å¤ªéƒ"                  |
| role         | string    | âœ…   | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²                       | "parent" / "child"      |
| familyId     | string    | âœ…   | å®¶æ—IDï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç”¨ï¼‰               | "family_123"            |
| createdAt    | Timestamp | âœ…   | ä½œæˆæ—¥æ™‚                             | serverTimestamp()       |

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `familyId + role` : å®¶æ—å†…ã®å­ã©ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ç”¨

### ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "id": "firebase_auth_uid_123",
  "email": "parent@example.com",
  "displayName": "ãŠæ¯ã•ã‚“",
  "role": "parent",
  "familyId": "family_abc123",
  "createdAt": "2024-01-01T00:00:00Z"
}
```

---

## 2. ğŸ“ tasks ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

æ—¥ã€…ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å   | å‹        | å¿…é ˆ | èª¬æ˜                       | ä¾‹                      |
| -------------- | --------- | ---- | -------------------------- | ----------------------- |
| id             | string    | âœ…   | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰ | "task_123abc"           |
| title          | string    | âœ…   | ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒˆãƒ«             | "æ­¯ç£¨ã"                |
| date           | string    | âœ…   | å®Ÿè¡Œæ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰   | "2024-01-15"            |
| createdBy      | string    | âœ…   | ä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID         | "firebase_auth_uid_123" |
| familyId       | string    | âœ…   | å®¶æ—ID                     | "family_123"            |
| childrenStatus | Object    | âœ…   | å­ã©ã‚‚ã”ã¨ã®å®Œäº†çŠ¶æ…‹       | ä¸‹è¨˜å‚ç…§                |
| createdAt      | Timestamp | âœ…   | ä½œæˆæ—¥æ™‚                   | serverTimestamp()       |

### childrenStatus ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```typescript
{
  [childId: string]: {
    isCompleted: boolean,     // å®Œäº†çŠ¶æ…‹
    comment: string,          // å­ã©ã‚‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
    completedAt?: Date        // å®Œäº†æ—¥æ™‚ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  }
}
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `familyId + date` : å®¶æ—ã®ç‰¹å®šæ—¥ã‚¿ã‚¹ã‚¯å–å¾—ç”¨
- `familyId + date (ç¯„å›²)` : ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®æ—¥ä»˜ç¯„å›²æ¤œç´¢

### ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "id": "task_xyz789",
  "title": "æœã®æ­¯ç£¨ã",
  "date": "2024-01-15",
  "createdBy": "parent_uid_123",
  "familyId": "family_abc123",
  "childrenStatus": {
    "child1_uid": {
      "isCompleted": true,
      "comment": "ãã‚Œã„ã«ç£¨ã‘ãŸï¼",
      "completedAt": "2024-01-15T07:30:00Z"
    },
    "child2_uid": {
      "isCompleted": false,
      "comment": ""
    }
  },
  "createdAt": "2024-01-15T06:00:00Z"
}
```

---

## 3. ğŸ“‹ taskTemplates ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

å†åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å | å‹        | å¿…é ˆ | èª¬æ˜                         | ä¾‹                                         |
| ------------ | --------- | ---- | ---------------------------- | ------------------------------------------ |
| id           | string    | âœ…   | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰   | "template_abc123"                          |
| title        | string    | âœ…   | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«         | "æ­¯ç£¨ã"                                   |
| createdBy    | string    | âœ…   | ä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID           | "parent_uid_123"                           |
| familyId     | string    | âœ…   | å®¶æ—ID                       | "family_123"                               |
| repeatType   | string    | âœ…   | ç¹°ã‚Šè¿”ã—ã‚¿ã‚¤ãƒ—               | "everyday" / "weekday" / "custom" / "none" |
| repeatDays   | number[]  | -    | ç¹°ã‚Šè¿”ã—æ›œæ—¥ï¼ˆcustomã®å ´åˆï¼‰ | [1, 2, 3, 4, 5]                            |
| createdAt    | Timestamp | âœ…   | ä½œæˆæ—¥æ™‚                     | serverTimestamp()                          |

### repeatType ã®å€¤

- `"none"` : ç¹°ã‚Šè¿”ã—ãªã—
- `"everyday"` : æ¯æ—¥
- `"weekday"` : å¹³æ—¥ã®ã¿ï¼ˆæœˆã€œé‡‘ï¼‰
- `"custom"` : ã‚«ã‚¹ã‚¿ãƒ ï¼ˆrepeatDaysã§æŒ‡å®šï¼‰

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `familyId` : å®¶æ—ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—ç”¨
- `createdBy + familyId` : ä½œæˆè€…åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—ç”¨

### ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "id": "template_morning_teeth",
  "title": "æœã®æ­¯ç£¨ã",
  "createdBy": "parent_uid_123",
  "familyId": "family_abc123",
  "repeatType": "everyday",
  "createdAt": "2024-01-01T00:00:00Z"
}
```

---

## 4. ğŸ† achievements ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

å­ã©ã‚‚ã®æ—¥åˆ¥é”æˆè¨˜éŒ²ã‚’ç®¡ç†

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å   | å‹        | å¿…é ˆ | èª¬æ˜                                   | ä¾‹                     |
| -------------- | --------- | ---- | -------------------------------------- | ---------------------- |
| id             | string    | âœ…   | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆ{userId}\_{date}å½¢å¼ï¼‰ | "child_uid_2024-01-15" |
| userId         | string    | âœ…   | å­ã©ã‚‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID                     | "child_uid_123"        |
| date           | string    | âœ…   | é”æˆæ—¥ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰               | "2024-01-15"           |
| completedCount | number    | âœ…   | å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯æ•°                       | 5                      |
| createdAt      | Timestamp | -    | åˆå›ä½œæˆæ—¥æ™‚                           | serverTimestamp()      |
| updatedAt      | Timestamp | âœ…   | æœ€çµ‚æ›´æ–°æ—¥æ™‚                           | serverTimestamp()      |

### ç‰¹æ®Šãªä»•æ§˜

- **è¤‡åˆã‚­ãƒ¼**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã¯ `{userId}_{date}` ã®å½¢å¼
- **è‡ªå‹•é›†è¨ˆ**: ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«è‡ªå‹•çš„ã«ã‚«ã‚¦ãƒ³ãƒˆãŒå¢—æ¸›
- **æ—¥åˆ¥ç®¡ç†**: 1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰ã§å­ã©ã‚‚ã®é”æˆçŠ¶æ³ã‚’è¨˜éŒ²

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- è‡ªç„¶ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã«ã‚ˆã‚‹æ¤œç´¢ï¼‰

### ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```json
{
  "id": "child_uid_123_2024-01-15",
  "userId": "child_uid_123",
  "date": "2024-01-15",
  "completedCount": 3,
  "createdAt": "2024-01-15T07:00:00Z",
  "updatedAt": "2024-01-15T19:30:00Z"
}
```

---

## ğŸ”— ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ

### ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®ä»•çµ„ã¿

```
Family Level Isolation:
â”œâ”€â”€ familyId ã‚’ã‚­ãƒ¼ã¨ã—ãŸå®Œå…¨åˆ†é›¢
â”œâ”€â”€ å®¶æ—é–“ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
â””â”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§å¼·åˆ¶

User Relationships:
â”œâ”€â”€ Parent (role: "parent")
â”‚   â”œâ”€â”€ ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆæ¨©é™
â”‚   â”œâ”€â”€ ã‚¿ã‚¹ã‚¯ä½œæˆæ¨©é™
â”‚   â””â”€â”€ å…¨ãƒ‡ãƒ¼ã‚¿é–²è¦§æ¨©é™
â””â”€â”€ Child (role: "child")
    â”œâ”€â”€ è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯å®Œäº†æ¨©é™
    â”œâ”€â”€ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ æ¨©é™
    â””â”€â”€ é”æˆè¨˜éŒ²é–²è¦§æ¨©é™
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
1. ã‚¿ã‚¹ã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆï¼ˆè¦ªï¼‰
   Parent â†’ taskTemplates

2. ã‚¿ã‚¹ã‚¯ç”Ÿæˆï¼ˆè¦ªï¼‰
   taskTemplates â†’ tasksï¼ˆchildrenStatusä»˜ãï¼‰

3. ã‚¿ã‚¹ã‚¯å®Œäº†ï¼ˆå­ï¼‰
   Child â†’ tasks.childrenStatus[childId]
   â””â”€â”€ åŒæ™‚ã« â†’ achievementsï¼ˆã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ ï¼‰

4. é”æˆè¨˜éŒ²ç¢ºèª
   achievements â†’ æ—¥åˆ¥ãƒ»å­åˆ¥ã®å®Œäº†æ•°è¡¨ç¤º
```

---

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«è¨­è¨ˆ

### åŸºæœ¬æ–¹é‡

1. **èªè¨¼å¿…é ˆ**: ã™ã¹ã¦ã®æ“ä½œã§èªè¨¼ãŒå¿…è¦
2. **å®¶æ—åˆ†é›¢**: ä»–ã®å®¶æ—ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
3. **å½¹å‰²åˆ¶å¾¡**: è¦ªãƒ»å­ã®å½¹å‰²ã«å¿œã˜ãŸæ“ä½œåˆ¶é™

### ä¸»è¦ãƒ«ãƒ¼ãƒ«

```javascript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
match /users/{userId} {
  allow read, write: if request.auth != null
    && request.auth.uid == userId;
}

// å®¶æ—ãƒ‡ãƒ¼ã‚¿ã¯åŒã˜familyIdã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
match /tasks/{taskId} {
  allow read, write: if request.auth != null
    && resource.data.familyId == getUserFamilyId(request.auth.uid);
}

// é”æˆè¨˜éŒ²ã¯æœ¬äººã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
match /achievements/{achievementId} {
  allow read, write: if request.auth != null
    && resource.data.userId == request.auth.uid;
}
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

1. **è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
   - `familyId + date` : æ—¥åˆ¥ã‚¿ã‚¹ã‚¯æ¤œç´¢
   - `familyId + role` : å®¶æ—å†…ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢

2. **å˜ä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**
   - `familyId` : å®¶æ—ãƒ‡ãƒ¼ã‚¿æ¤œç´¢
   - `userId` : ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ãƒ‡ãƒ¼ã‚¿æ¤œç´¢

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

- æ—¥ä»˜ç¯„å›²æ¤œç´¢ã§ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
- å¿…è¦æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å–å¾—
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã®é©åˆ‡ãªé…ç½®

---

## APIä½¿ç”¨ä¾‹

### ã‚¿ã‚¹ã‚¯ä½œæˆ

```typescript
await taskAPI.create({
  title: 'æœã®æ­¯ç£¨ã',
  date: '2024-01-15',
  createdBy: 'parent_uid',
  familyId: 'family_123',
  childrenStatus: {
    child1_uid: {
      isCompleted: false,
      comment: '',
    },
    child2_uid: {
      isCompleted: false,
      comment: '',
    },
  },
})
```

### é”æˆè¨˜éŒ²ã®æ›´æ–°

```typescript
// ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
await achievementAPI.incrementCount('child1_uid', '2024-01-15')
```

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [APIä»•æ§˜æ›¸](api-reference.md) - è©³ç´°ãªAPIä»•æ§˜ã¨ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](architecture.md) - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­è¨ˆã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
- [é–‹ç™ºç’°å¢ƒæ§‹ç¯‰](development-setup.md) - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
- [README.md](README.md) - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

### ğŸ“‹ å®Ÿè£…æ™‚ã®å‚è€ƒ

- **APIå®Ÿè£…**: `src/lib/api/` å†…ã®å„ãƒ•ã‚¡ã‚¤ãƒ«
- **å‹å®šç¾©**: `src/types/task.ts`
- **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `src/components/` å†…ã®é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
